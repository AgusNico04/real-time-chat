<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
</head>
<body>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; }

        #chat-input { display: block; position: fixed; bottom: 6px; left: 21vw; right: 0; border: none; padding: 12px 1rem; border-radius: 2rem; background:rgb(31, 31, 31); width: 72.5vw;}
        #chat-input:focus { outline: none; }
        #send-btn { position: fixed; width: 60px; right: 10px; bottom: 6px; background: rgb(34, 30, 70); border: none; padding: 12px; border-radius: 7px; outline: none; }
  
        #messages-container { list-style-type: none; padding: 0; position: static; display: block; width: 80vw; margin-top: 8.3vh; margin-left: 20vw; margin-bottom: 15vh; }
        #messages-container > li { padding: 0.5rem 1rem; }
        #messages-container > li:nth-child(odd) { background: #efefef; }

        #actions { height: 8.3vh; display: block; margin-top: 0; position: fixed; top: 0; left: 20vw; right: 0; padding: 0; background: rgb(34, 30, 70); }
        #actions > p { text-align: center; color: rgb(0, 0, 0); }

        #contacts { width: 20vw; height: 100vh; position: fixed; background: rgb(0, 0, 0); top: 0; left: 0; padding: 0; }
        #contacts > p { text-align: center; color: lightslategray; }

        #contact-list { list-style: none; margin: 0; padding: 0; }
        #contact-list > li { display: block; margin: 0; }
        #contact-list > li > button { width: 100%; padding: 20px; background: rgb(0, 0, 0); border: none; outline: none; color: lightslategray; }

        #new-contact-input { position: fixed; bottom: 8%; left: 0; width: 20vw; background: rgb(31, 31, 31); padding: 13px 10px; color: rgb(0, 0, 0); border: none; }
        #new-contact-input::placeholder { color: rgb(0, 0, 0); }
        #new-contact-input:focus { outline: none; }

        #new-contact-button { position: fixed; bottom: 0; left: 0; width: 20vw; padding: 16px 0; background:rgb(34, 30, 70); border: none; }
        #new-contact-button::placeholder { color: rgb(19, 19, 19) }
        #new-contact-button:focus { outline: none; }
    </style>
    
    <div id="contacts">
        <p>Contactos</p>
        <ul id="contact-list">

        </ul>

        <input type="text" placeholder="Añade un usuario" id="new-contact-input"><button id="new-contact-button">Añadir</button>
    </div>

    <div id="actions"><p></p></div>

    <ul id="messages-container"></ul>

    <input id="chat-input" autocomplete="off" placeholder="Mensaje"><button id="send-btn">Enviar</button>
    

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({autoConnect: false});
        
        const input = document.getElementById('chat-input');
        const btn = document.getElementById('send-btn');
        const messagesContainer = document.getElementById('messages-container');
        const actions = document.getElementById('actions');

        const newContactInput = document.getElementById('new-contact-input');
        const newContactBtn = document.getElementById('new-contact-button');
        const contactList = document.getElementById('contact-list');

        const messages = new Map();
        const contacts = new Map();
        let selectedUser = '';
        let selfID;
        let currentChat = '';
        let user;

        const sessionID = JSON.parse(localStorage.getItem('sessionID'));
        console.log(sessionID, Boolean(sessionID));
        if (sessionID) {
            socket.auth = { sessionID }
            socket.connect();
        }
        else {
            (function selectUser() {
                user = prompt('Elige un nombre de usuario');
                if (!Boolean(user)) selectUser();
            })();
            socket.auth = { username: user }
            socket.connect();
            socket.emit('username-selected', { username: user });
        }

        function displayMessage(data) {
            let li = document.createElement('li');
            li.innerHTML = data;
            messagesContainer.appendChild(li);
        }

        function getChatID(fromID, to) {
            if (fromID === to) return fromID;
            else if (fromID.length !== to.length) {
                return fromID.length > to.length ? `${fromID}-${to}` : `${to}-${fromID}`;
            }
            else if (fromID.charCodeAt(0) > to.charCodeAt(0)) {
                return `${fromID}-${to}`;
            }
            else if (fromID.charCodeAt(0) < to.charCodeAt(0)) {
                return `${to}-${fromID}`;
            }
            
            for (let i = 1; i < fromID.length; i++) {
                if (fromID.charCodeAt(i) > to.charCodeAt(i)) {
                    return `${fromID}-${to}`
                }
                else if (fromID.charCodeAt(i) < to.charCodeAt(i)) {
                    return `${to}-${fromID}`;
                }
            }
        }

        newContactBtn.addEventListener('click', e => {
            e.preventDefault();
            if (newContactInput.value) {
                if (contacts.get(selfID).includes(newContactInput.value)) {
                    return socket.emit('error', 002)
                }
                
                const li = document.createElement('li');
                const newButton = document.createElement('button');

                newButton.innerHTML = newContactInput.value;
                newButton.setAttribute('data-user', newContactInput.value);

                li.appendChild(newButton);
                contactList.appendChild(li);
                contacts.get(selfID).push(newContactInput.value);

                const button = li.getElementsByTagName('button')[0];
                const contactName = button.getAttribute('data-user');

                socket.emit('add-contact', { contact: contactName });

                li.addEventListener('click', () => {
                    for (let li of contactList.getElementsByTagName('li')) {
                        const button = li.getElementsByTagName('button')[0];
                        button.style = `background: rgb(0, 0, 0)`;
                    }
                    button.style = `background: rgb(34, 30, 70)`;
                    socket.emit('select-user', { selectedUser: contactName });
                });

                li.addEventListener('typing', () => button.innerHTML += ' está escribiendo...');
                li.addEventListener('typing-stop', () => button.innerHTML = contactName);
            }
        });

        actions.addEventListener('typing', () => {
            let p = actions.getElementsByTagName('p')[0];
            p.innerHTML += ' está escribiendo...';
            actions.addEventListener('typing-stop', () => { 
                p.innerHTML = selectedUser.username;
            });
        });

        btn.addEventListener('click', e => {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat-message', { msg: input.value, from: user });
                socket.emit('typing-stop', { user: user });
                input.value = '';
                window.scrollTo(0, document.body.scrollHeight + 1000);
            }
        });

        input.addEventListener('keypress', e => {
            if (e.keyCode === 13 && input.value) {
                socket.emit('chat-message', { msg: input.value, from: user });
                input.value = '';
                window.scrollTo(0, document.body.scrollHeight + 1000);
            }
        });

        input.addEventListener('focus', () => {
            socket.emit('typing-start', { user: user });
        });

        input.addEventListener('focusout', () => {
            socket.emit('typing-stop', { user: user });
        });

        socket.on('select-username', () => {
            (function selectUser() {
                user = prompt('Elige un nombre de usuario');
                if (!Boolean(user)) selectUser();
            })();
            socket.emit('username-selected', { username: user });
        });

        socket.on('session', data => {
            socket.auth = { sessionID: data.sessionID }

            selfID = data.userID;
            contacts.set(selfID, []);
            for(const [key, value] of Object.entries(data.messages)) {
                messages.set(key, value);
            }

            localStorage.setItem('sessionID', JSON.stringify(data.sessionID));
        });

        socket.on('get-self-username', data => user = data.username);

        socket.on('chat-message', data => {
            if (data.from.ID === selfID || data.to.ID === selfID) {
                currentChat = getChatID(data.from.ID, data.to.ID);

                if (!messages.has(currentChat)) {
                    messages.set(currentChat, [{ from: data.from.username, msg: data.msg }]);
                }
                else {
                    messages.get(currentChat).push({ from: data.from.username, msg: data.msg });
                }

                if (data.from.ID === selfID && selectedUser) displayMessage(`${data.from.username} (Tu): ${data.msg}`);
                else if (data.from.ID === selectedUser.ID && data.to.ID === selfID) displayMessage(`${data.from.username}: ${data.msg}`);
            }
        });

        socket.on('load-messages', data => {
            currentChat = getChatID(data.from.ID, data.to.ID);
            selectedUser = data.to;
            messagesContainer.innerHTML = '';

            if (messages.has(currentChat)) {
                for (const msg of messages.get(currentChat)) {
                    if (msg.from === user) displayMessage(`${msg.from} (Tu): ${msg.msg}`);
                    else displayMessage(`${msg.from}: ${msg.msg}`);
                }
            }

            let p = actions.getElementsByTagName('p')[0];
            p.innerHTML = selectedUser.username;

            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('load-contacts', data => {
            for (const [key, value] of Object.entries(data.contacts)) {
                if (key === selfID) {
                    value.forEach(contact => {
                        if (!contacts.get(selfID).includes(contact)) {
                            const li = document.createElement('li');
                            const newButton = document.createElement('button');

                            newButton.innerHTML = contact;
                            newButton.setAttribute('data-user', contact);

                            li.appendChild(newButton);
                            contactList.appendChild(li);

                            const button = li.getElementsByTagName('button')[0];
                            const contactName = button.getAttribute('data-user');

                            li.addEventListener('click', () => {
                                for (let li of contactList.getElementsByTagName('li')) {
                                    const button = li.getElementsByTagName('button')[0];
                                    button.style = `background: rgb(0, 0, 0)`;
                                }
                                button.style = `background: rgb(34, 30, 70)`;
                                socket.emit('select-user', { selectedUser: contactName });
                            });

                            li.addEventListener('typing', () => button.innerHTML += ' está escribiendo...');
                            li.addEventListener('typing-stop', () => button.innerHTML = contactName);
                        }
                    });
                }
            }
        });

        socket.on('error', errorID => {
            switch (errorID) {
                case 001:
                    alert('Error: User does not exist');
                    break;
            
                case 002:
                    alert('Error: User already in contact list');
                    break;

                case 003:
                    alert('Error: Username is taken or blank');
                    user = prompt('Elige un nombre de usuario');
                    socket.emit('username-selected', { username: user });
                    socket.emit('get-self-id', { user: user });
                    break;

                default:
                    alert('Unknown error');
                    break;
            }
        });
        
        socket.on('typing-start', data => {
            if (data.to === selfID) {
                const typingEvent = new Event('typing');
                if (data.from === selectedUser.username) actions.dispatchEvent(typingEvent);

                const contacts = contactList.getElementsByTagName('li');
                for (let li of contacts) {
                    const button = li.getElementsByTagName('button')[0];
                    const contactName = button.getAttribute('data-user');
                    if (contactName === data.from) li.dispatchEvent(typingEvent);
                }
            }
        });

        socket.on('typing-stop', data => {
            if (data.to === selfID) {
                const typingEvent = new Event('typing-stop');
                if (data.from === selectedUser.username) actions.dispatchEvent(typingEvent);

                const contacts = contactList.getElementsByTagName('li');
                for (let li of contacts) {
                    const button = li.getElementsByTagName('button')[0];
                    const contactName = button.getAttribute('data-user');
                    if (contactName === data.from) li.dispatchEvent(typingEvent);
                }
            }
        });
    </script>
</body>
</html>