<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
</head>
<body>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; }

        #chat-input { display: block; position: fixed; bottom: 6px; left: 21vw; right: 0; border: none; padding: 12px 1rem; border-radius: 2rem; background:rgb(31, 31, 31); width: 72.5vw;}
        #chat-input:focus { outline: none; }
        #send-btn { position: fixed; width: 60px; right: 10px; bottom: 6px; background: rgb(34, 30, 70); border: none; padding: 12px; border-radius: 7px; outline: none; }
  
        #messages-container { list-style-type: none; padding: 0; position: static; display: block; width: 80vw; margin-top: 8.3vh; margin-left: 20vw; margin-bottom: 15vh; }
        #messages-container > li { padding: 0.5rem 1rem; }
        #messages-container > li:nth-child(odd) { background: #efefef; }

        #actions { height: 8.3vh; display: block; margin-top: 0; position: fixed; top: 0; left: 20vw; right: 0; padding: 0; background: rgb(34, 30, 70); }
        #actions > p { text-align: center; color: rgb(0, 0, 0); }

        #contacts { width: 20vw; height: 100vh; position: fixed; background: rgb(0, 0, 0); top: 0; left: 0; padding: 0; }
        #contacts > p { text-align: center; color: lightslategray; }

        #contact-list { list-style: none; margin: 0; padding: 0; }
        #contact-list > li { display: block; margin: 0; }
        #contact-list > li > button { width: 100%; padding: 20px; background: rgb(0, 0, 0); border: none; outline: none; color: lightslategray; }

        #new-contact-input { position: fixed; bottom: 16%; left: 0; width: 20vw; background: rgb(31, 31, 31); padding: 13px 10px; color: rgb(0, 0, 0); border: none; }
        #new-contact-input::placeholder { color: rgb(0, 0, 0); }
        #new-contact-input:focus { outline: none; }

        #new-contact-button { position: fixed; bottom: 8%; left: 0; width: 20vw; padding: 16px 0; background:rgb(34, 30, 70); border: none; }
        #new-contact-button::placeholder { color: rgb(19, 19, 19) }
        #new-contact-button:focus { outline: none; }
        #new-contact-button:hover { background: rgb(21, 19, 44); }

        #new-group-button { position: fixed; bottom: 0; left: 0; width: 20vw; padding: 16px 0; background:rgb(34, 30, 70); border: none }
        #new-group-button::placeholder { color: rgb(19, 19, 19) }
        #new-group-button:focus { outline: none; }
        #new-group-button:hover { background: rgb(21, 19, 44); }
    </style>
    
    <div id="contacts">
        <p>Contactos</p>
        <ul id="contact-list">

        </ul>
        
        <input type="text" placeholder="Añade un usuario" id="new-contact-input"><button id="new-contact-button">Añadir Contacto</button><button id="new-group-button">Añadir Grupo</button>
    </div>

    <div id="actions"><p></p></div>

    <ul id="messages-container"></ul>

    <input id="chat-input" autocomplete="off" placeholder="Mensaje"><button id="send-btn">Enviar</button>
    

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({autoConnect: false});
        
        const input = document.getElementById('chat-input');
        const btn = document.getElementById('send-btn');
        const messagesContainer = document.getElementById('messages-container');
        const actions = document.getElementById('actions');

        const newContactInput = document.getElementById('new-contact-input');
        const newContactBtn = document.getElementById('new-contact-button');
        const newGroupBtn = document.getElementById('new-group-button');
        const contactList = document.getElementById('contact-list');

        const messages = new Map();
        const contacts = new Map();
        let selectedChat = '';
        let selfID;
        let currentChat = '';
        let user;

        function selectUser() {
            user = prompt('Elige un nombre de usuario');
            if (!Boolean(user)) selectUser();
        }

        const sessionID = JSON.parse(localStorage.getItem('sessionID'));
        if (sessionID) {
            socket.auth = { sessionID }
            socket.connect();
        }
        else {
            selectUser();
            socket.auth = { username: user }
            socket.connect();
        }

        function displayMessage(data) {
            let li = document.createElement('li');
            li.innerHTML = data;
            messagesContainer.appendChild(li);
        }

        function saveMessages(messagesStore, currentChat, data) {
            if (!messagesStore.has(currentChat)) {
                messagesStore.set(currentChat, [{ from: data.from, msg: data.msg }]);
            }
            else {
                messagesStore.get(currentChat).push({ from: data.from, msg: data.msg });
            }
        }

        function getChatID(fromID, to) {
            if (fromID === to) return fromID;
            else if (fromID.length !== to.length) {
                return fromID.length > to.length ? `${fromID}-${to}` : `${to}-${fromID}`;
            }
            else if (fromID.charCodeAt(0) > to.charCodeAt(0)) {
                return `${fromID}-${to}`;
            }
            else if (fromID.charCodeAt(0) < to.charCodeAt(0)) {
                return `${to}-${fromID}`;
            }
            
            for (let i = 1; i < fromID.length; i++) {
                if (fromID.charCodeAt(i) > to.charCodeAt(i)) {
                    return `${fromID}-${to}`
                }
                else if (fromID.charCodeAt(i) < to.charCodeAt(i)) {
                    return `${to}-${fromID}`;
                }
            }
        }

        newContactBtn.addEventListener('click', e => {
            e.preventDefault();
            const newContact = newContactInput.value;
            if (newContact) {
                if (contacts.has(selfID)) {
                    if (contacts.get(selfID).includes(newContact)) return socket.emit('error', 002);
                }
                else contacts.set(selfID, []);
                
                const li = document.createElement('li');
                const newButton = document.createElement('button');

                newButton.innerHTML = newContact === user ? `${newContact} (Tu)`: newContact;
                newButton.setAttribute('data-user', newContact);

                li.appendChild(newButton);
                contactList.appendChild(li);
                contacts.get(selfID).push({ name: newContact, type: 'private' });

                const button = li.getElementsByTagName('button')[0];
                const name = button.getAttribute('data-user');

                socket.emit('add-contact', { name: name, type: 'private' });

                const bg = button.style;
                li.addEventListener('click', () => {
                    for (let li of contactList.getElementsByTagName('li')) {
                        const button = li.getElementsByTagName('button')[0];
                        button.style = `background: rgb(0, 0, 0)`;
                    }
                    bg.background = 'rgb(34, 30, 70)';
                    socket.emit('select-user', { selectedChat: name, type: 'private' });
                });

                li.addEventListener('mouseover', () => {
                    if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(31, 31, 31)';
                });

                li.addEventListener('mouseout', () => {
                    if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(0, 0, 0)';
                });

                li.addEventListener('typing', () => button.innerHTML += ' está escribiendo...');
                li.addEventListener('typing-stop', () => button.innerHTML = name === user ? `${name} (Tu)` : name);
            }
        });

        newGroupBtn.addEventListener('click', e => {
            e.preventDefault();
            const newGroup = newContactInput.value;
            if (newGroup) {
                if (contacts.has(selfID)) {
                    if (contacts.get(selfID).includes(newGroup)) return socket.emit('error', 002);
                }
                else contacts.set(selfID, []);

                const li = document.createElement('li');
                const newButton = document.createElement('button');

                newButton.innerHTML = `${newGroup} (Grupo)`;
                newButton.setAttribute('data-user', newGroup);

                li.appendChild(newButton);
                contactList.appendChild(li);
                contacts.get(selfID).push({ name: newGroup, type: 'group' });

                const button = li.getElementsByTagName('button')[0];
                const name = button.getAttribute('data-user');

                socket.emit('add-contact', { name: name, type: 'group' });

                const bg = button.style;
                li.addEventListener('click', () => {
                    for (let li of contactList.getElementsByTagName('li')) {
                        const button = li.getElementsByTagName('button')[0];
                        button.style = `background: rgb(0, 0, 0)`;
                    }
                    bg.background = 'rgb(34, 30, 70)';
                    socket.emit('select-user', { selectedChat: name, type: 'group' });
                });

                li.addEventListener('mouseover', () => {
                    if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(31, 31, 31)';
                });

                li.addEventListener('mouseout', () => {
                    if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(0, 0, 0)';
                });

                li.addEventListener('typing', () => {            
                    button.innerHTML += ` está escribiendo...`;
                });
                        
                li.addEventListener('typing-stop', () => { 
                    button.innerHTML = `${name} (Grupo)`;
                });
            }
        });

        actions.addEventListener('typing', () => {
            let p = actions.getElementsByTagName('p')[0];
            p.innerHTML += ' está escribiendo...';
            actions.addEventListener('typing-stop', () => { 
                p.innerHTML = selectedChat.username === user ? `${selectedChat.username} (Tu)`: selectedChat.username;
            });
        });

        btn.addEventListener('click', e => {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat-message', { msg: input.value, from: user, type: selectedChat.chat.type });
                socket.emit('typing-stop', { user: user });
                input.value = '';
                window.scrollTo(0, document.body.scrollHeight + 1000);
            }
        });

        input.addEventListener('keypress', e => {
            if (e.keyCode === 13 && input.value) {
                socket.emit('chat-message', { msg: input.value, from: user, type: selectedChat.chat.type });
                input.value = '';
                window.scrollTo(0, document.body.scrollHeight + 1000);
            }
        });

        input.addEventListener('focus', () => {
            socket.emit('typing-start', { user: user });
        });

        input.addEventListener('focusout', () => {
            socket.emit('typing-stop', { user: user });
        });

        socket.on('session', data => {
			socket.auth = { sessionID: data.sessionID }
						
            selfID = data.userID;
            for (const [key, value] of Object.entries(data.messages)) {
                messages.set(key, value);
            }

            localStorage.setItem('sessionID', JSON.stringify(data.sessionID));
        });

        socket.on('get-self-username', data => user = data.username);

        socket.on('private-message', data => {
            if (data.from.ID === selfID || data.to.ID === selfID) {
                currentChat = getChatID(data.from.ID, data.to.ID);
                saveMessages(messages, currentChat, { from: data.from.username, msg: data.msg });

                if (data.from.ID === selfID && selectedChat) displayMessage(`${data.from.username} (Tu): ${data.msg}`);
                else if (data.from.ID === selectedChat.to.ID && data.to.ID === selfID) displayMessage(`${data.from.username}: ${data.msg}`);
            }
        });

        socket.on('group-message', data => {
            if (data.from.ID === selfID || data.to.groupName === selectedChat.to.groupName) {
                currentChat = data.to.groupName;
                saveMessages(messages, currentChat, { from: data.from.username, msg: data.msg });

                if (data.from.ID === selfID && selectedChat) displayMessage(`${data.from.username} (Tu): ${data.msg}`);
                else displayMessage(`${data.from.username}: ${data.msg}`);
            }
        });

        socket.on('load-messages', data => {
            if (data.chat.type === 'private') {
                currentChat = getChatID(data.from.ID, data.to.ID);
                selectedChat = { to: { ID: data.to.ID, username: data.to.username }, chat: { type: data.chat.type }}
                messagesContainer.innerHTML = '';

                if (messages.has(currentChat)) {
                    for (const msg of messages.get(currentChat)) {
                        if (msg.from === user) displayMessage(`${msg.from} (Tu): ${msg.msg}`);
                        else displayMessage(`${msg.from}: ${msg.msg}`);
                    }
                }

                const p = actions.getElementsByTagName('p')[0];
                p.innerHTML = selectedChat.to.username === user ? `${selectedChat.to.username} (Tu)`: selectedChat.to.username;

                window.scrollTo(0, document.body.scrollHeight);
            }
            else if (data.chat.type === 'group') {
                currentChat = data.to.groupName;
                selectedChat = { to: { groupName: currentChat }, chat: { type: data.chat.type }}
                messagesContainer.innerHTML = '';

                if (messages.has(currentChat)) {
                    for (const msg of messages.get(currentChat)) {
                        if (msg.from === user) displayMessage(`${msg.from} (Tu): ${msg.msg}`);
                        else displayMessage(`${msg.from}: ${msg.msg}`);
                    }
                }

                const p = actions.getElementsByTagName('p')[0];
                p.innerHTML = selectedChat.to.groupName;

                window.scrollTo(0, document.body.scrollHeight);
            }
        });

        socket.on('load-contacts', data => {
            for (const [key, values] of Object.entries(data.contacts)) {
                if (key === selfID) {
                    for(const contactInfo of values) {
                        if (contacts.has(selfID)) {
                            if (contacts.get(selfID).includes(contactInfo)) continue;
                        }
                        else contacts.set(selfID, []);

                        const li = document.createElement('li');
                        const newButton = document.createElement('button');

                        if (contactInfo.type === 'private') {
                            newButton.innerHTML = contactInfo.name === user ? `${contactInfo.name} (Tu)`: contactInfo.name;
                            newButton.setAttribute('data-user', contactInfo.name);
                        }
                        else if (contactInfo.type === 'group') {
                            newButton.innerHTML = `${contactInfo.name} (Grupo)`;
                            newButton.setAttribute('data-user', contactInfo.name);
                        }

                        li.appendChild(newButton);
                        contactList.appendChild(li);
                        contacts.get(selfID).push(contactInfo);

                        const button = li.getElementsByTagName('button')[0];
                        const name = button.getAttribute('data-user');

                        const bg = button.style;
                        li.addEventListener('click', () => {
                            for (let li of contactList.getElementsByTagName('li')) {
                                const button = li.getElementsByTagName('button')[0];
                                button.style = `background: rgb(0, 0, 0)`;
                            }
                            bg.background = 'rgb(34, 30, 70)';
                            if (contactInfo.type === 'private') {
                                socket.emit('select-user', { selectedChat: name, type: 'private' });
                            }
                            else if (contactInfo.type === 'group') {
                                socket.emit('select-user', { selectedChat: name, type: 'group' });
                            }
                        });
                    
                        li.addEventListener('mouseover', () => {
                            if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(31, 31, 31)';
                        });
                    
                        li.addEventListener('mouseout', () => {
                            if (bg.background !== 'rgb(34, 30, 70)') bg.background = 'rgb(0, 0, 0)';
                        });

                        li.addEventListener('typing', () => { 
                            if (contactInfo.type === 'private') {
                                button.innerHTML += ' está escribiendo...';
                            }
                            else if (contactInfo.type === 'group') {
                                button.innerHTML += `${contactInfo.name} está escribiendo`;
                            }
                        });

                        li.addEventListener('typing-stop', () => { 
                            if (contactInfo.type === 'private') {
                                button.innerHTML = contactInfo.name === user ? `${contactInfo.name} (Tu)` : contactInfo.name;
                            }
                            else if (contactInfo.type === 'group') {
                                button.innerHTML = `${contactInfo.name} (Grupo)`;
                            }
                        });
                    }
                }
            }
        });

        socket.on('error', errorID => {
            switch (errorID) {
                case 001:
                    alert('Error: User does not exist');
                    break;
            
                case 002:
                    alert('Error: User already in contact list');
                    break;

                default:
                    alert('Unknown error');
                    break;
            }
        });
        
        socket.on('typing-start', data => {
            if (data.to === selfID) {
                const typingEvent = new Event('typing');
                if (data.from === selectedChat.to.username) actions.dispatchEvent(typingEvent);

                const contacts = contactList.getElementsByTagName('li');
                for (let li of contacts) {
                    const button = li.getElementsByTagName('button')[0];
                    const contactName = button.getAttribute('data-user');
                    if (contactName === data.from) li.dispatchEvent(typingEvent);
                }
            }
        });

        socket.on('typing-stop', data => {
            if (data.to === selfID) {
                const typingEvent = new Event('typing-stop');
                if (data.from === selectedChat.to.username) actions.dispatchEvent(typingEvent);

                const contacts = contactList.getElementsByTagName('li');
                for (let li of contacts) {
                    const button = li.getElementsByTagName('button')[0];
                    const contactName = button.getAttribute('data-user');
                    if (contactName === data.from) li.dispatchEvent(typingEvent);
                }
            }
        });

        socket.on('connect_error', () => {
            alert('Error: Username is taken or blank');
            selectUser();
            socket.auth = { username: user }
            socket.connect();
        });
    </script>
</body>
</html>